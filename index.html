<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MM ç—‡ç‹€å°ˆå®¶åˆ†æç³»çµ± - é†«ç™‚éˆåª’ç™‚ç™’æŒ‡å—</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0284c7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .source-link:hover { text-decoration: underline; color: #0ea5e9; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        input[type="checkbox"] { accent-color: #0284c7; width: 1.1rem; height: 1.1rem; cursor: pointer; }
    </style>
</head>
<body class="text-slate-900">

    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-sky-500 rounded-2xl shadow-lg shadow-sky-200">
                    <i data-lucide="stethoscope" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">MM ç—‡ç‹€å°ˆå®¶åˆ†æç³»çµ±</h1>
                    <p class="text-slate-500 text-sm font-medium">Medical Medium Healing Wisdom V4.7 (Stable PWA)</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 rounded-full bg-white shadow-sm border border-slate-200 hover:bg-slate-50 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
            </button>
        </header>

        <!-- Search Section -->
        <div class="glass-card rounded-3xl p-6 shadow-xl mb-8 border border-sky-100">
            <h2 class="text-lg font-bold mb-4 text-slate-700 flex items-center gap-2">
                <i data-lucide="search" class="w-5 h-5 text-sky-500"></i> è«‹è¼¸å…¥æ‚¨çš„èº«é«”ç—‡ç‹€
            </h2>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="symptomInput" placeholder="ä¾‹å¦‚ï¼šèƒŒç—›ã€å¤±æ™ºã€æ¿•ç–¹ã€åé ­ç—›..." 
                       class="flex-grow p-4 rounded-2xl bg-white border border-slate-200 focus:ring-2 focus:ring-sky-500/20 outline-none text-lg transition-all">
                <button id="analyzeBtn" class="bg-sky-600 hover:bg-sky-700 text-white px-8 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-sky-100 disabled:bg-slate-400">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> å•Ÿå‹•å°ˆå®¶åˆ†æ
                </button>
            </div>
            <p class="text-[11px] text-slate-400 mt-4 flex items-center gap-1">
                <i data-lucide="info" class="w-3 h-3"></i> ç³»çµ±å°‡çµåˆ Medical Medium è‘—ä½œçŸ¥è­˜åº«èˆ‡ Google æœå°‹é€²è¡Œç²¾ç¢ºæº¯æºã€‚
            </p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden glass-card rounded-3xl p-16 text-center shadow-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto mb-4"></div>
            <p id="loadingText" class="text-slate-600 font-bold loading-pulse">æ­£åœ¨æ·±åº¦æª¢ç´¢æ›¸ç±æ–‡ç»èˆ‡ç¶²è·¯æ–‡ç« ...</p>
        </div>

        <!-- Result Display -->
        <div id="resultContent" class="hidden space-y-6">
            <div class="glass-card rounded-3xl p-8 shadow-lg border-l-8 border-rose-400 animate-fade-in">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="activity" class="text-rose-400 w-4 h-4"></i>
                    <h3 class="text-rose-600 font-black text-[10px] uppercase tracking-widest">Medical Insight / æ ¸å¿ƒç—…å› </h3>
                </div>
                <div id="rootCause" class="text-xl text-slate-800 font-bold leading-relaxed"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-emerald-50" style="animation-delay: 0.1s">
                    <h3 class="flex items-center gap-2 font-bold text-emerald-600 mb-4 text-sm">
                        <i data-lucide="apple" class="w-4 h-4"></i> æ¨è–¦ç™‚ç™’é£Ÿç‰©
                    </h3>
                    <ul id="healingFoods" class="space-y-2 text-slate-600 text-sm"></ul>
                </div>
                <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-amber-50" style="animation-delay: 0.2s">
                    <h3 class="flex items-center gap-2 font-bold text-amber-600 mb-4 text-sm">
                        <i data-lucide="pill" class="w-4 h-4"></i> å»ºè­°è£œå……å“
                    </h3>
                    <ul id="supplements" class="space-y-2 text-slate-600 text-sm"></ul>
                </div>
            </div>

            <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-sky-50" style="animation-delay: 0.3s">
                <h3 class="flex items-center gap-2 font-bold text-sky-600 mb-4 text-sm">
                    <i data-lucide="book-open" class="w-4 h-4"></i> å°ˆå®¶æ”¹å–„å»ºè­°èˆ‡ç™‚ç™’è·¯å¾‘
                </h3>
                <div id="expertGuidance" class="text-slate-700 leading-relaxed space-y-4 text-sm"></div>
            </div>

            <div class="bg-slate-900 text-slate-300 rounded-3xl p-6 shadow-xl animate-fade-in border border-slate-700" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="flex items-center gap-2 font-bold text-sky-300 text-sm">
                        <i data-lucide="library" class="w-4 h-4"></i> è«–è¿°å‡ºè™•èˆ‡åƒè€ƒè³‡æ–™
                    </h3>
                    <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded-full text-slate-400">Grounded Results</span>
                </div>
                <div id="citations" class="space-y-3"></div>
            </div>

            <!-- Email Section (Ported from detox_ref) -->
            <div id="emailSection" class="glass-card rounded-3xl p-6 shadow-xl border-2 border-sky-100 animate-fade-in">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4">
                    <i data-lucide="mail" class="text-sky-500"></i> ç™¼é€åˆ†æå ±å‘Š
                </h3>
                
                <div class="space-y-4">
                    <div id="recipientListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <!-- Recipient checkboxes -->
                    </div>

                    <div class="flex gap-2">
                        <input type="email" id="newEmailInput" placeholder="æ–°å¢å…¶ä»–ä¿¡ç®±..." class="flex-grow p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500/20 outline-none text-sm">
                        <button onclick="addRecipient()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all text-sm flex items-center gap-1">
                            <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
                        </button>
                    </div>

                    <button id="sendEmailBtn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 transition-all flex items-center justify-center gap-2 shadow-lg mt-2">
                        <i data-lucide="send" class="w-5 h-5"></i> ç™¼é€å®Œæ•´è¡¨æ ¼å ±å‘Š
                    </button>
                    <p id="emailStatus" class="text-center text-xs font-medium hidden mt-2"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i> ç³»çµ±è¨­å®š
            </h3>
            <input type="password" id="apiKeyInput" placeholder="Gemini API Key" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 mb-6 font-mono text-sm outline-none">
            <button onclick="saveSettings()" class="w-full py-4 bg-sky-600 text-white rounded-xl font-bold shadow-lg mb-2">å„²å­˜è¨­å®š</button>
            <button onclick="toggleSettings()" class="w-full py-2 text-slate-400 font-medium text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- Service Worker Safe Registration ---
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('SW Registered'))
                    .catch(err => console.warn('SW Registration deferred (Sandbox or Path mismatch)'));
            });
        }

        // --- State ---
        let config = { apiKey: localStorage.getItem('mm_symptom_api_key') || "" };
        let currentResult = null;
        let lastSymptom = "";
        let recipients = [
            { email: "oliver603@gmail.com", selected: true },
            { email: "yofarn@gmail.com", selected: true }
        ];

        const analyzeBtn = document.getElementById('analyzeBtn');
        const symptomInput = document.getElementById('symptomInput');
        const loadingState = document.getElementById('loadingState');
        const resultContent = document.getElementById('resultContent');
        const emailStatus = document.getElementById('emailStatus');

        lucide.createIcons();
        if (window.emailjs) window.emailjs.init("mYOFMMnqLdDxR0wjj");

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
            document.getElementById('apiKeyInput').value = config.apiKey;
        }

        function saveSettings() {
            const val = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('mm_symptom_api_key', val);
            config.apiKey = val;
            toggleSettings();
        }

        function renderRecipients() {
            const container = document.getElementById('recipientListContainer');
            container.innerHTML = recipients.map((r, idx) => `
                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 bg-white/50 cursor-pointer hover:bg-white shadow-sm">
                    <input type="checkbox" ${r.selected ? 'checked' : ''} onchange="toggleRecipient(${idx})">
                    <span class="text-xs font-mono text-slate-600 truncate">${r.email}</span>
                </label>
            `).join('');
            lucide.createIcons();
        }

        function toggleRecipient(idx) { recipients[idx].selected = !recipients[idx].selected; }
        function addRecipient() {
            const input = document.getElementById('newEmailInput');
            const email = input.value.trim();
            if (email && /^\S+@\S+\.\S+$/.test(email)) { recipients.push({ email, selected: true }); input.value = ''; renderRecipients(); }
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 || response.status >= 500) { await new Promise(r => setTimeout(r, delay)); delay *= 2; continue; }
                    throw new Error(`HTTP ${response.status}`);
                } catch (err) { if (i === maxRetries - 1) throw err; await new Promise(r => setTimeout(r, delay)); delay *= 2; }
            }
        }

        analyzeBtn.onclick = async () => {
            const symptom = symptomInput.value.trim();
            if (!symptom) return alert("è«‹è¼¸å…¥ç—‡ç‹€ã€‚");
            if (!config.apiKey) return toggleSettings();
            setLoading(true);
            lastSymptom = symptom;
            try {
                const result = await callGeminiWithMM(symptom);
                currentResult = result;
                renderResults(result);
                renderRecipients();
            } catch (err) { alert("åˆ†æå¤±æ•—ï¼š" + err.message); }
            finally { setLoading(false); }
        };

        async function callGeminiWithMM(userQuery) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå®‰æ±å°¼Â·å¨å»‰ã€Šé†«ç™‚éˆåª’ã€‹(Medical Medium) ç‡Ÿé¤Šé«”ç³»çš„æ¬Šå¨å°å¸«ã€‚
            è«‹é‡å°ç”¨æˆ¶ç—‡ç‹€ï¼Œä»¥å°ˆæ¥­ MM è§’åº¦åˆ†æç—…å› ä¸¦æä¾›æ–¹æ¡ˆã€‚
            å›æ‡‰æ ¼å¼è«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON çµæ§‹ï¼ˆç¦æ­¢å›å‚³ Markdownï¼‰ï¼š
            {
              "root_cause": "æ ¸å¿ƒç—…å›  (ä¾‹å¦‚ï¼šEBç—…æ¯’ç¬¬4å‹ã€éˆçƒèŒæ„ŸæŸ“ã€æœ‰å®³é‡é‡‘å±¬è² è·)",
              "healing_foods": ["ç™‚ç™’é£Ÿç‰©åç¨± (å«ç°¡çŸ­åŸå› )"],
              "supplements": ["å»ºè­°è£œå……å“ (å«ç°¡çŸ­åŸå› )"],
              "expert_guidance": "åˆ†æ®µèªªæ˜çš„è©³ç´°æ”¹å–„å»ºè­°èˆ‡æ—¥å¸¸å®ˆå‰‡",
              "structured_sources": [
                 { "type": "book", "title": "è‘—ä½œæ›¸å", "detail": "ç« ç¯€é—œéµå­—" }
              ]
            }`;

            const payload = {
                contents: [{ parts: [{ text: `ç”¨æˆ¶ç—‡ç‹€æè¿°ï¼š${userQuery}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }]
            };
            const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const data = await response.json();
            const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const groundingMetadata = data.candidates?.[0]?.groundingMetadata;
            
            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error("ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼");
            const parsed = JSON.parse(jsonMatch[0]);
            
            const webSources = groundingMetadata?.groundingAttributions?.map(a => ({
                type: "web", title: a.web?.title || "MM Online Resource", uri: a.web?.uri || "#"
            })) || [];
            
            parsed.sources = Array.from(new Set([...(parsed.structured_sources || []), ...webSources].map(s => s.title)))
                .map(title => [...(parsed.structured_sources || []), ...webSources].find(s => s.title === title));
            return parsed;
        }

        function renderResults(data) {
            resultContent.classList.remove('hidden');
            document.getElementById('rootCause').innerText = data.root_cause || "æœªåµæ¸¬åˆ°æ˜ç¢ºç—…å› ";
            document.getElementById('healingFoods').innerHTML = (data.healing_foods || []).map(f => `<li class="flex items-start gap-2 mb-1"><i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500 mt-0.5"></i> <span>${f}</span></li>`).join('');
            document.getElementById('supplements').innerHTML = (data.supplements || []).map(s => `<li class="flex items-start gap-2 mb-1"><i data-lucide="plus-circle" class="w-3.5 h-3.5 text-amber-500 mt-0.5"></i> <span>${s}</span></li>`).join('');
            document.getElementById('expertGuidance').innerHTML = (data.expert_guidance || "").split('\n').filter(p => p.trim()).map(p => `<p class="mb-3">${p}</p>`).join('');
            document.getElementById('citations').innerHTML = (data.sources || []).map(s => `
                <div class="flex items-start gap-3 p-3 bg-slate-800/40 rounded-xl border border-slate-700/50">
                    <div class="p-2 rounded-lg bg-slate-700"><i data-lucide="${s.type === 'book' ? 'book' : 'globe'}" class="w-4 h-4 text-sky-400"></i></div>
                    <div class="flex-grow overflow-hidden text-xs text-slate-100">
                        <span class="font-bold block truncate">${s.title}</span>
                        ${s.uri ? `<a href="${s.uri}" target="_blank" class="source-link text-sky-500 truncate block">${s.uri}</a>` : ''}
                    </div>
                </div>`).join('');
            lucide.createIcons();
            window.scrollTo({ top: resultContent.offsetTop - 20, behavior: 'smooth' });
        }

        function setLoading(l) {
            loadingState.classList.toggle('hidden', !l);
            analyzeBtn.disabled = l;
            if (l) resultContent.classList.add('hidden');
            lucide.createIcons();
        }

        document.getElementById('sendEmailBtn').onclick = async () => {
            const selectedEmails = recipients.filter(r => r.selected).map(r => r.email);
            if (!currentResult || selectedEmails.length === 0) return alert("è«‹ç¢ºèªæœ‰çµæœä¸”é¸æ“‡æ”¶ä»¶äºº");
            const sendBtn = document.getElementById('sendEmailBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = `ç™¼é€ä¸­...`;
            const dateStr = new Date().toISOString().split('T')[0];
            const emailHtml = `
                <div style="font-family: Arial; max-width: 800px; margin: 0 auto; color: #333; background-color: #f0f9ff; padding: 20px; border-radius: 12px;">
                    <h2 style="color: #0284c7; text-align: center;">MM ç—‡ç‹€åˆ†æå ±å‘Š (${dateStr})</h2>
                    <p><strong>åˆ†æç—‡ç‹€ï¼š</strong> ${lastSymptom}</p>
                    <table width="100%" style="border-collapse: collapse; background: white; border: 1px solid #bae6fd;">
                        <tr style="background: #0284c7; color: white;"><th style="padding: 12px; text-align: left;">ç—…å› </th><th style="padding: 12px; text-align: left;">å»ºè­°æ–¹æ¡ˆ</th></tr>
                        <tr>
                            <td style="padding: 15px; vertical-align: top; border: 1px solid #bae6fd;"><strong>${currentResult.root_cause}</strong></td>
                            <td style="padding: 15px; border: 1px solid #bae6fd;">
                                <strong>ğŸŒ¿ é£Ÿç‰©ï¼š</strong><ul>${currentResult.healing_foods.map(f => `<li>${f}</li>`).join('')}</ul>
                                <strong>ğŸ’Š è£œå……å“ï¼š</strong><ul>${currentResult.supplements.map(s => `<li>${s}</li>`).join('')}</ul>
                            </td>
                        </tr>
                    </table>
                    <p style="font-size: 14px; margin-top: 15px;">${currentResult.expert_guidance.replace(/\n/g, '<br/>')}</p>
                </div>
            `;
            const templateParams = { email: selectedEmails.join(','), to_email: selectedEmails.join(','), recipient: selectedEmails.join(','), subject: `MM Report: ${lastSymptom}`, message: emailHtml };
            window.emailjs.send('service_5yh7x6g', 'template_dlbyml8', templateParams)
                .then(() => { emailStatus.innerText = "âœ… æˆåŠŸç™¼é€ï¼"; emailStatus.classList.remove('hidden'); })
                .catch(() => { alert("ç™¼é€å¤±æ•—"); })
                .finally(() => { sendBtn.disabled = false; sendBtn.innerHTML = `ç™¼é€å®Œæ•´è¡¨æ ¼å ±å‘Š`; });
        };
    </script>
</body>
</html>