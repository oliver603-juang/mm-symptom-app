<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MM é£Ÿå“å°ˆå®¶åˆ†æç³»çµ± - é†«ç™‚éˆåª’æ¬Šé‡ç‰ˆ</title>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .tier-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 999px; font-weight: 700; text-transform: uppercase; }
        .tier-1 { background-color: #fee2e2; color: #991b1b; }
        .tier-2 { background-color: #ffedd5; color: #9a3412; }
        .tier-3 { background-color: #f1f5f9; color: #475569; }
        .redemption { background-color: #dcfce7; color: #166534; }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        input[type="checkbox"] { accent-color: #10b981; width: 1.15rem; height: 1.15rem; cursor: pointer; }
    </style>
</head>
<body class="text-slate-900">

    <div id="app" class="max-w-5xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-500 rounded-2xl shadow-lg shadow-emerald-200 text-white">
                    <i data-lucide="leaf" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">MM é£Ÿå“å°ˆå®¶åˆ†æç³»çµ±</h1>
                    <p class="text-slate-500 text-sm font-medium">Medical Medium Wisdom V5.0 (Full Fixed)</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 rounded-full bg-white shadow-sm border border-slate-200 hover:bg-slate-50 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Panel -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card rounded-3xl p-6 shadow-xl border-emerald-100/50">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <i data-lucide="camera" class="w-5 h-5"></i> æ”å–ä¾†æºè¼¸å…¥
                    </h2>
                    
                    <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center hover:border-emerald-400 transition-all cursor-pointer bg-white/40 group">
                        <input type="file" id="fileInput" class="hidden" accept="image/*" multiple>
                        <div id="uploadPlaceholder">
                            <i data-lucide="image-plus" class="w-12 h-12 mx-auto text-slate-300 mb-3 group-hover:text-emerald-400 transition-colors"></i>
                            <p class="text-slate-500 text-sm font-medium">æ‹æ”é£Ÿå“æˆ–æˆåˆ†è¡¨ (å¯å¤šé¸)</p>
                        </div>
                        <div id="imageGrid" class="hidden grid grid-cols-3 gap-2 mt-2"></div>
                    </div>

                    <button id="analyzeBtn" class="w-full mt-6 py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-bold shadow-lg shadow-emerald-200 transition-all flex justify-center items-center gap-2 disabled:opacity-50">
                        <i data-lucide="brain-circuit" class="w-5 h-5"></i> å•Ÿå‹• MM åˆ†å±¤æ¬Šé‡åˆ†æ
                    </button>
                    <button id="clearBtn" class="hidden w-full mt-3 py-2 text-slate-400 text-xs hover:text-red-500 font-medium">é‡è¨­è³‡æ–™</button>
                </div>

                <!-- Legend -->
                <div class="bg-white/60 rounded-3xl p-5 border border-slate-100 space-y-3">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest text-center mb-2">MM æ¬Šé‡æ¼”ç®—æ³•</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-[11px]"><span class="text-red-600 font-bold">Tier 1 (è›‹å¥¶éº©)</span><span class="font-mono">-40%</span></div>
                        <div class="flex items-center justify-between text-[11px]"><span class="text-orange-600 font-bold">Tier 2 (ç‰ç±³/å¤§è±†/èŠ¥èŠ±æ²¹)</span><span class="font-mono">-25%</span></div>
                        <div class="flex items-center justify-between text-[11px]"><span class="text-slate-500 font-bold">Tier 3 (ç²¾è£½ç³–/é†‹)</span><span class="font-mono">-15%</span></div>
                        <div class="flex items-center justify-between text-[11px]"><span class="text-emerald-600 font-bold">ğŸŒ¿ æ•‘è´–æ©Ÿåˆ¶ (è—¥è‰è”¬æœ)</span><span class="font-mono">+20%</span></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-8 space-y-6">
                <div id="loadingState" class="hidden glass-card rounded-3xl p-16 text-center shadow-lg">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto mb-4"></div>
                    <p id="loadingText" class="text-slate-600 font-bold text-lg">æ­£åœ¨æ·±åº¦æƒæ Trouble Foods...</p>
                </div>

                <div id="resultsList" class="space-y-6"></div>

                <!-- Email Management Section -->
                <div id="emailSection" class="hidden glass-card rounded-3xl p-6 shadow-xl border-2 border-emerald-50 animate-slide-up">
                    <div class="flex items-center justify-between mb-4 border-b border-emerald-50 pb-3">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="users" class="text-emerald-500"></i> æ”¶ä»¶äººç®¡ç†
                        </h3>
                    </div>

                    <div id="recipientListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                        <!-- Recipients injected via JS -->
                    </div>

                    <div class="flex gap-2 mb-6">
                        <input type="email" id="newEmailInput" placeholder="æ–°å¢ä¿¡ç®±..." class="flex-grow p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500/20 outline-none text-sm bg-white">
                        <button onclick="addRecipient()" class="px-5 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 text-sm flex items-center gap-1">
                            <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
                        </button>
                    </div>

                    <button id="sendEmailBtn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 transition-all flex items-center justify-center gap-2 shadow-lg">
                        <i data-lucide="send" class="w-5 h-5"></i> ç™¼é€å®Œæ•´ MM åˆ†æå ±è¡¨
                    </button>
                    <p id="emailStatus" class="text-center text-xs font-bold mt-3 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                <i data-lucide="key" class="text-slate-400"></i> ç³»çµ±å¼•æ“è¨­å®š
            </h3>
            <p class="text-slate-500 text-sm mb-6 leading-relaxed">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥å•Ÿå‹•å°ˆå®¶åˆ†æåŠŸèƒ½ã€‚</p>
            
            <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥é‡‘é‘°..." class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-emerald-500/50 mb-4 font-mono text-sm outline-none transition-all">
            
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex items-center gap-2 text-xs font-bold text-emerald-600 hover:text-emerald-700 transition-colors group mb-8">
                <i data-lucide="external-link" class="w-3 h-3 transition-transform group-hover:-translate-y-0.5 group-hover:translate-x-0.5"></i>
                é»æ­¤å…è²»å–å¾—æ‚¨çš„ API Key
            </a>

            <button onclick="saveSettings()" class="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-100 mb-2">å„²å­˜è¨­å®š</button>
            <button onclick="toggleSettings()" class="w-full py-2 text-slate-400 font-medium text-sm">ç¨å¾Œå†èªª</button>
        </div>
    </div>

    <script>
        // --- System State ---
        let state = {
            apiKey: localStorage.getItem('mm_expert_api_key') || "",
            images: [],
            results: [],
            recipients: [
                { email: "oliver603@gmail.com", selected: true },
                { email: "yofarn@gmail.com", selected: true }
            ]
        };

        // --- MM Expert Engine (Calculation Logic) ---
        class MMEngine {
            constructor() {
                this.weights = { tier1: 40, tier2: 25, tier3: 15, redemption: 20 };
            }
            calculate(data) {
                let score = 100;
                if (data.mm_tier1_count > 0) score -= (data.mm_tier1_count * this.weights.tier1);
                if (data.mm_tier2_count > 0) score -= (data.mm_tier2_count * this.weights.tier2);
                if (data.mm_tier3_count > 0) score -= (data.mm_tier3_count * this.weights.tier3);
                if (data.redemption_count > 0) score += (data.redemption_count * this.weights.redemption);
                return Math.max(0, Math.min(100, score));
            }
            getSafetyInfo(score) {
                if (score >= 85) return { label: 'æ¥µè‡´ç´”æ·¨', color: 'text-emerald-600', icon: 'shield-check' };
                if (score >= 65) return { label: 'ä½è² æ“”', color: 'text-emerald-500', icon: 'check-circle' };
                if (score >= 40) return { label: 'éåº¦åŠ å·¥', color: 'text-orange-500', icon: 'alert-circle' };
                return { label: 'é«˜åº¦é•ç¦', color: 'text-red-600', icon: 'shield-alert' };
            }
        }
        const mmEngineInstance = new MMEngine();

        // --- Image Compression for Email (Fix 413 Limit) ---
        const compressForEmail = (dataUrl, maxWidth = 80) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.4));
                };
                img.src = dataUrl;
            });
        };

        // --- UI Interactions ---
        lucide.createIcons();
        if (window.emailjs) window.emailjs.init("mYOFMMnqLdDxR0wjj");

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
            document.getElementById('apiKeyInput').value = state.apiKey;
        }

        function saveSettings() {
            state.apiKey = document.getElementById('apiKeyInput').value;
            localStorage.setItem('mm_expert_api_key', state.apiKey);
            toggleSettings();
        }

        function renderRecipients() {
            const container = document.getElementById('recipientListContainer');
            if (!container) return;
            container.innerHTML = state.recipients.map((r, idx) => `
                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 bg-white cursor-pointer hover:shadow-sm transition-all">
                    <input type="checkbox" ${r.selected ? 'checked' : ''} onchange="toggleRecipient(${idx})">
                    <span class="text-xs font-mono text-slate-700 truncate">${r.email}</span>
                </label>
            `).join('');
            lucide.createIcons();
        }

        function toggleRecipient(idx) { state.recipients[idx].selected = !state.recipients[idx].selected; }
        function addRecipient() {
            const input = document.getElementById('newEmailInput');
            const email = input.value.trim();
            if (email && /^\S+@\S+\.\S+$/.test(email)) {
                state.recipients.push({ email, selected: true });
                input.value = '';
                renderRecipients();
            }
        }

        const fileInput = document.getElementById('fileInput');
        const imageGrid = document.getElementById('imageGrid');
        const analyzeBtn = document.getElementById('analyzeBtn');

        document.getElementById('dropZone').onclick = () => fileInput.click();
        fileInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const preview = ev.target.result;
                    const emailThumb = await compressForEmail(preview);
                    state.images.push({ 
                        base64: preview.split(',')[1], 
                        preview, 
                        emailThumb,
                        type: file.type || 'image/jpeg' 
                    });
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    imageGrid.classList.remove('hidden');
                    document.getElementById('clearBtn').classList.remove('hidden');
                    const div = document.createElement('div');
                    div.className = "aspect-square rounded-xl overflow-hidden border border-slate-100 shadow-sm animate-slide-up";
                    div.innerHTML = `<img src="${preview}" class="w-full h-full object-cover">`;
                    imageGrid.appendChild(div);
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('clearBtn').onclick = () => location.reload();

        analyzeBtn.onclick = async () => {
            if (state.images.length === 0) return alert("è«‹å…ˆé¸æ“‡ç…§ç‰‡ã€‚");
            if (!state.apiKey) return toggleSettings();

            setLoading(true);
            document.getElementById('resultsList').innerHTML = "";
            state.results = [];

            try {
                for (let i = 0; i < state.images.length; i++) {
                    updateStatus(`æ­£åœ¨å‰–æç¬¬ ${i + 1}/${state.images.length} é …é£Ÿå“...`);
                    const result = await callGeminiAPI(state.images[i]);
                    result.thumbnail = state.images[i].preview;
                    result.emailThumb = state.images[i].emailThumb;
                    state.results.push(result);
                    renderCard(result);
                    if (i < state.images.length - 1) await new Promise(r => setTimeout(r, 1200));
                }
                document.getElementById('emailSection').classList.remove('hidden');
                renderRecipients();
                window.scrollTo({ top: document.getElementById('emailSection').offsetTop - 50, behavior: 'smooth' });
            } catch (err) {
                alert("åˆ†æå¤±æ•—: " + err.message);
            } finally {
                setLoading(false);
            }
        };

        // --- Core Algorithm (Stable Expert Prompt) ---
        async function callGeminiAPI(imgData) {
            const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå®‰æ±å°¼Â·å¨å»‰ã€Šé†«ç™‚éˆåª’ã€‹(Medical Medium) ç‡Ÿé¤Šé«”ç³»çš„å°ˆå®¶ã€‚è«‹åˆ†æåœ–ç‰‡ä¸¦ä»¥ JSON å›å‚³ï¼š
            {
              "name": "é£Ÿå“åç¨±",
              "mm_tier1_count": Tier 1 (è›‹ã€å¥¶ã€éº©è³ª) æ•¸é‡,
              "mm_tier2_count": Tier 2 (ç‰ç±³ã€å¤§è±†ã€èŠ¥èŠ±æ²¹ã€å¤©ç„¶é¦™æ–™) æ•¸é‡,
              "mm_tier3_count": Tier 3 (ç²¾è£½ç³–ã€é†‹ã€éé‡æ²¹è„‚) æ•¸é‡,
              "redemption_count": æ•‘è´–åŠ åˆ†æ•¸é‡,
              "detected_items": ["è«‹å°‡æˆåˆ†æŒ‰ç…§ Tier æ¯’æ€§ç”±é«˜åˆ°ä½æ’åˆ—æ¸…å–®"],
              "expert_guidance": "è«‹åŒ…å«å…©éƒ¨åˆ†ï¼š1.åˆ†æ®µèªªæ˜é‡å°æ’æ¯’çš„å…·é«”å¼•å°å»ºè­°ï¼›2.åˆ†æ®µèªªæ˜æ¯’æ€§æœ€é«˜çš„æˆåˆ†é€ æˆçš„å…·é«”å‚·å®³ (100å­—å…§)",
              "structured_sources": [
                { "type": "book", "title": "è‘—ä½œæ›¸å (ä¾‹å¦‚ï¼šæ‹¯æ•‘è‚è‡Ÿ)", "detail": "å…·é«”ç« ç¯€æˆ–è«–é»æ‘˜è¦" },
                { "type": "web", "title": "æ–‡ç« æ¨™é¡Œ", "uri": "URL é€£çµ" }
              ]
            }

            **é—œæ–¼åƒè€ƒè³‡æ–™ (Sources) çš„åš´æ ¼è¦æ±‚ï¼š**
            1. ä½ å¿…é ˆæ˜ç¢ºæŒ‡å‡ºè«–è¿°æ˜¯å‡ºè‡ªå“ªä¸€æœ¬è‘—ä½œ (ä¾‹å¦‚ï¼šã€Šé†«ç™‚éˆåª’ã€‹ã€ã€Šæ‹¯æ•‘è‚è‡Ÿã€‹ã€ã€Šç”²ç‹€è…ºç™‚ç™’ã€‹ã€ã€Šæ·¨åŒ–ç™‚ç™’ã€‹ã€ã€Šå¤§è…¦ç™‚ç™’ã€‹ã€ã€Šå®ˆè­·å¤§è…¦ã€‹)ã€‚
            2. å¦‚æœæ˜¯å‡ºè‡ªå®˜æ–¹ç¶²ç«™ã€éƒ¨è½æ ¼æˆ– Podcastï¼Œè«‹æä¾›å…·é«”çš„æ–‡ç« æ¨™é¡Œã€‚
            3. è«‹å°‡ä¾†æºåˆ†é¡ç‚º "book" (å¯¦é«”æ›¸å¼•ç”¨) æˆ– "web" (ç·šä¸Šæ–‡ç« )ã€‚
            åªå›å‚³ JSONï¼Œç¦æ­¢ä»»ä½• Markdown æ¨™è¨˜èªå¥ã€‚`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: imgData.type, data: imgData.base64 } }] }]
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API èª¿ç”¨ç•°å¸¸");
            const data = await response.json();
            const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error("AI å›å‚³å…§å®¹ä¸å®Œæ•´");
            return JSON.parse(jsonMatch[0]);
        }

        function renderCard(data) {
            const score = mmEngineInstance.calculate(data);
            const info = mmEngineInstance.getSafetyInfo(score);
            const card = document.createElement('div');
            card.className = "glass-card rounded-3xl p-6 shadow-lg flex gap-6 animate-slide-up border-l-8";
            card.style.borderLeftColor = score < 50 ? '#ef4444' : '#10b981';
            card.innerHTML = `
                <div class="w-32 h-32 flex-shrink-0 rounded-2xl overflow-hidden shadow-inner border border-slate-100 bg-slate-50">
                    <img src="${data.thumbnail}" class="w-full h-full object-cover">
                </div>
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">${data.name}</h3>
                            <p class="text-xs font-bold ${info.color} flex items-center gap-1 uppercase">
                                <i data-lucide="${info.icon}" class="w-3 h-3"></i> ${info.label}
                            </p>
                        </div>
                        <div class="text-center">
                            <span class="text-4xl font-black ${info.color}">${score}</span>
                            <p class="text-[8px] font-black text-slate-300 uppercase tracking-tighter">MM Rating</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${data.mm_tier1_count > 0 ? `<span class="tier-badge tier-1">T1 x${data.mm_tier1_count}</span>` : ''}
                        ${data.mm_tier2_count > 0 ? `<span class="tier-badge tier-2">T2 x${data.mm_tier2_count}</span>` : ''}
                        ${data.mm_tier3_count > 0 ? `<span class="tier-badge tier-3">T3 x${data.mm_tier3_count}</span>` : ''}
                        ${data.redemption_count > 0 ? `<span class="tier-badge redemption">ğŸŒ¿ x${data.redemption_count}</span>` : ''}
                    </div>
                    <div class="p-3 bg-slate-50/50 rounded-xl border border-slate-100 italic text-xs text-slate-600 mb-3">
                        "${data.expert_guidance.replace(/\n/g, '<br/>')}"
                    </div>
                    <div class="text-[10px] text-slate-400 bg-white/40 p-2 rounded-xl border border-slate-50">
                        <strong class="text-slate-600 block mb-1 uppercase font-black tracking-widest">è‘—ä½œæ–‡ç»æº¯æºï¼š</strong>
                        ${(data.structured_sources || []).map(s => `
                            <div class="flex items-center gap-1 mb-0.5">
                                <i data-lucide="${s.type === 'book' ? 'book' : 'globe'}" class="w-2.5 h-2.5"></i>
                                <span>${s.title}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('resultsList').appendChild(card);
            lucide.createIcons();
        }

        // --- Email Send Function (Fixed Params Based on detox_ref) ---
        document.getElementById('sendEmailBtn').onclick = async () => {
            const selectedEmails = state.recipients.filter(r => r.selected).map(r => r.email);
            const statusEl = document.getElementById('emailStatus');
            if (selectedEmails.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ”¶ä»¶äººã€‚");
            
            const btn = document.getElementById('sendEmailBtn');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> æ­£åœ¨æ‰¹æ¬¡ç™¼é€...`;
            lucide.createIcons();

            const dateStr = new Date().toISOString().split('T')[0];
            const rows = state.results.map(r => {
                const s = mmEngineInstance.calculate(r);
                return `
                    <tr style="border-bottom: 1px solid #eeeeee;">
                        <td style="padding: 10px; text-align: center;"><img src="${r.emailThumb}" width="60" style="border-radius: 6px; border: 1px solid #eee;"></td>
                        <td style="padding: 12px; font-family: sans-serif;"><strong style="font-size: 15px; color:#333;">${r.name}</strong><br><small style="color:#999;">T1:${r.mm_tier1_count} | T2:${r.mm_tier2_count}</small></td>
                        <td style="padding: 12px; text-align: center;"><div style="background-color: ${s < 50 ? '#ef4444' : '#10b981'}; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 15px; display:inline-block;">${s}</div></td>
                        <td style="padding: 12px; font-size: 11px; color: #666; font-style: italic;">"${r.expert_guidance.replace(/\n/g, ' ')}"</td>
                    </tr>
                `;
            }).join('');

            const emailHtml = `
                <div style="max-width: 700px; margin: 0 auto; font-family: sans-serif; background-color: #ffffff; border: 1px solid #eeeeee; border-radius: 12px; overflow: hidden;">
                    <div style="background-color: #10b981; color: #ffffff; padding: 25px; text-align: center;">
                        <h2 style="margin: 0; font-size: 22px;">MM é£Ÿå“å°ˆå®¶åˆ†æå ±å‘Š</h2>
                        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.8;">Report Date: ${dateStr}</p>
                    </div>
                    <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">
                        <thead style="background-color: #f8fafc; font-size: 11px; color: #64748b; text-align: left;">
                            <tr><th style="padding: 12px; text-align:center;">åœ–ç‰‡</th><th style="padding: 12px;">é£Ÿå“è³‡è¨Š</th><th style="padding: 12px; text-align:center;">MM åˆ†æ•¸</th><th style="padding: 12px;">å°ˆå®¶åˆ†æèˆ‡å¼•å°</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div style="padding: 15px; text-align: center; font-size: 10px; color: #94a3b8; background-color: #f8fafc;">æ­¤éƒµä»¶ç”± MM AI å°ˆå®¶ç³»çµ±è‡ªå‹•ç™¼é€ã€‚</div>
                </div>
            `;

            // Fixed template params based on detox_ref.txt requirements
            const templateParams = {
                email: selectedEmails.join(','),
                to_email: selectedEmails.join(','),
                recipient: selectedEmails.join(','),
                subject: `MM Food Expert Report - ${dateStr}`,
                message: emailHtml
            };

            try {
                await emailjs.send("service_5yh7x6g", "template_dlbyml8", templateParams);
                statusEl.innerText = "âœ… å ±å‘Šå·²ç™¼é€æˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±ã€‚";
                statusEl.className = "text-center text-xs font-bold text-emerald-600 animate-pulse mt-3 block";
            } catch (e) {
                console.error(e);
                statusEl.innerText = "âŒ ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– EmailJS è¨­å®šã€‚";
                statusEl.className = "text-center text-xs font-bold text-red-600 mt-3 block";
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i> ç™¼é€å®Œæ•´ MM åˆ†æå ±è¡¨`;
                lucide.createIcons(); statusEl.classList.remove('hidden');
            }
        };

        // --- Helpers ---
        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('mm_expert_api_key', document.getElementById('apiKeyInput').value);
            state.apiKey = document.getElementById('apiKeyInput').value;
            toggleSettings();
        }
        function setLoading(l) { 
            document.getElementById('loadingState').classList.toggle('hidden', !l); 
            analyzeBtn.disabled = l; 
            if (l) document.getElementById('emailSection').classList.add('hidden');
        }
        function updateStatus(t) { document.getElementById('loadingText').innerText = t; }
    </script>
</body>
</html>
