<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MM ç—‡ç‹€å°ˆå®¶åˆ†æç³»çµ± - é†«ç™‚éˆåª’ç™‚ç™’æŒ‡å—</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0284c7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .source-link:hover { text-decoration: underline; color: #0ea5e9; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        input[type="checkbox"] { accent-color: #0284c7; width: 1.1rem; height: 1.1rem; cursor: pointer; }
    </style>
</head>
<body class="text-slate-900">

    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-sky-500 rounded-2xl shadow-lg shadow-sky-200">
                    <i data-lucide="stethoscope" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">MM ç—‡ç‹€å°ˆå®¶åˆ†æç³»çµ±</h1>
                    <p class="text-slate-500 text-sm font-medium">Medical Medium Healing Wisdom V4.9 (Full Edition)</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 rounded-full bg-white shadow-sm border border-slate-200 hover:bg-slate-50 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
            </button>
        </header>

        <!-- Search Section -->
        <div class="glass-card rounded-3xl p-6 shadow-xl mb-8 border border-sky-100">
            <h2 class="text-lg font-bold mb-4 text-slate-700 flex items-center gap-2">
                <i data-lucide="search" class="w-5 h-5 text-sky-500"></i> è«‹è¼¸å…¥æ‚¨çš„èº«é«”ç—‡ç‹€
            </h2>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="symptomInput" placeholder="ä¾‹å¦‚ï¼šèƒŒç—›ã€å¤±æ™ºã€æ¿•ç–¹ã€åé ­ç—›..." 
                       class="flex-grow p-4 rounded-2xl bg-white border border-slate-200 focus:ring-2 focus:ring-sky-500/20 outline-none text-lg transition-all">
                <button id="analyzeBtn" class="bg-sky-600 hover:bg-sky-700 text-white px-8 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-sky-100 disabled:bg-slate-400">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> å•Ÿå‹•å°ˆå®¶åˆ†æ
                </button>
            </div>
            <p class="text-[11px] text-slate-400 mt-4 flex items-center gap-1">
                <i data-lucide="info" class="w-3 h-3"></i> ç³»çµ±å°‡çµåˆ Medical Medium å…¨ç³»åˆ—è‘—ä½œçŸ¥è­˜åº«èˆ‡è¯ç¶²æŠ€è¡“ã€‚
            </p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden glass-card rounded-3xl p-16 text-center shadow-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto mb-4"></div>
            <p id="loadingText" class="text-slate-600 font-bold loading-pulse">æ­£åœ¨ç²¾ç¢ºæª¢ç´¢ã€Šé†«ç™‚éˆåª’ã€‹æ ¸å¿ƒè«–è¿°...</p>
        </div>

        <!-- Result Display -->
        <div id="resultContent" class="hidden space-y-6">
            <div class="glass-card rounded-3xl p-8 shadow-lg border-l-8 border-rose-400 animate-fade-in">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="activity" class="text-rose-400 w-4 h-4"></i>
                    <h3 class="text-rose-600 font-black text-[10px] uppercase tracking-widest">Medical Insight / æ ¸å¿ƒç—…å› </h3>
                </div>
                <div id="rootCause" class="text-xl text-slate-800 font-bold leading-relaxed"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-emerald-50" style="animation-delay: 0.1s">
                    <h3 class="flex items-center gap-2 font-bold text-emerald-600 mb-4 text-sm">
                        <i data-lucide="apple" class="w-4 h-4"></i> æ¨è–¦ç™‚ç™’é£Ÿç‰©
                    </h3>
                    <ul id="healingFoods" class="space-y-2 text-slate-600 text-sm"></ul>
                </div>
                <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-amber-50" style="animation-delay: 0.2s">
                    <h3 class="flex items-center gap-2 font-bold text-amber-600 mb-4 text-sm">
                        <i data-lucide="pill" class="w-4 h-4"></i> å»ºè­°è£œå……å“
                    </h3>
                    <ul id="supplements" class="space-y-2 text-slate-600 text-sm"></ul>
                </div>
            </div>

            <div class="glass-card rounded-3xl p-6 shadow-md animate-fade-in border border-sky-50" style="animation-delay: 0.3s">
                <h3 class="flex items-center gap-2 font-bold text-sky-600 mb-4 text-sm">
                    <i data-lucide="book-open" class="w-4 h-4"></i> å°ˆå®¶æ”¹å–„å»ºè­°èˆ‡ç™‚ç™’è·¯å¾‘
                </h3>
                <div id="expertGuidance" class="text-slate-700 leading-relaxed space-y-4 text-sm"></div>
            </div>

            <div class="bg-slate-900 text-slate-300 rounded-3xl p-6 shadow-xl animate-fade-in border border-slate-700" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="flex items-center gap-2 font-bold text-sky-300 text-sm">
                        <i data-lucide="library" class="w-4 h-4"></i> è«–è¿°å‡ºè™•èˆ‡åƒè€ƒè³‡æ–™
                    </h3>
                    <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded-full text-slate-400">Grounded Results</span>
                </div>
                <div id="citations" class="space-y-3"></div>
            </div>

            <!-- Email Section -->
            <div id="emailSection" class="glass-card rounded-3xl p-6 shadow-xl border-2 border-sky-100 animate-fade-in">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4">
                    <i data-lucide="mail" class="text-sky-500"></i> ç™¼é€åˆ†æå ±å‘Š
                </h3>
                
                <div class="space-y-4">
                    <div id="recipientListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <!-- Recipient checkboxes -->
                    </div>

                    <div class="flex gap-2">
                        <input type="email" id="newEmailInput" placeholder="æ–°å¢å…¶ä»–ä¿¡ç®±..." class="flex-grow p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500/20 outline-none text-sm bg-white">
                        <button onclick="addRecipient()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all text-sm flex items-center gap-1">
                            <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
                        </button>
                    </div>

                    <button id="sendEmailBtn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 transition-all flex items-center justify-center gap-2 shadow-lg mt-2">
                        <i data-lucide="send" class="w-5 h-5"></i> ç™¼é€å®Œæ•´è¡¨æ ¼å ±å‘Š
                    </button>
                    <p id="emailStatus" class="text-center text-xs font-medium hidden mt-2"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i> ç³»çµ±è¨­å®š
                </h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <p class="text-xs text-slate-500 mb-4">è«‹è¼¸å…¥ Google Gemini API Key ä»¥å•Ÿå‹•è¯ç¶²åˆ†æåŠŸèƒ½ã€‚</p>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Google Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥é‡‘é‘°..." class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-sky-500/50 font-mono text-sm outline-none">
                
                <!-- API Key Link -->
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="mt-3 flex items-center gap-2 text-xs font-bold text-sky-600 hover:text-sky-700 transition-colors group">
                    <i data-lucide="external-link" class="w-3 h-3 transition-transform group-hover:-translate-y-0.5 group-hover:translate-x-0.5"></i>
                    é»æ­¤å‰å¾€ Google AI Studio å…è²»å–å¾— API Key
                </a>
            </div>

            <button onclick="saveSettings()" class="w-full py-4 bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-100 mb-2 hover:bg-sky-700 transition-colors">å„²å­˜è¨­å®š</button>
            <button onclick="toggleSettings()" class="w-full py-2 text-slate-400 font-medium text-sm">ç¨å¾Œå†èªª</button>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('SW Registered'))
                    .catch(() => console.warn('SW Register deferred'));
            });
        }

        // --- System State ---
        let config = { apiKey: localStorage.getItem('mm_symptom_api_key') || "" };
        let currentResult = null;
        let lastSymptom = "";
        let recipients = [
            { email: "oliver603@gmail.com", selected: true },
            { email: "yofarn@gmail.com", selected: true }
        ];

        const analyzeBtn = document.getElementById('analyzeBtn');
        const symptomInput = document.getElementById('symptomInput');
        const loadingState = document.getElementById('loadingState');
        const resultContent = document.getElementById('resultContent');
        const emailStatus = document.getElementById('emailStatus');

        lucide.createIcons();
        if (window.emailjs) window.emailjs.init("mYOFMMnqLdDxR0wjj");

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
            document.getElementById('apiKeyInput').value = config.apiKey;
        }

        function saveSettings() {
            const val = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('mm_symptom_api_key', val);
            config.apiKey = val;
            toggleSettings();
        }

        function renderRecipients() {
            const container = document.getElementById('recipientListContainer');
            container.innerHTML = recipients.map((r, idx) => `
                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 bg-white/50 cursor-pointer hover:bg-white transition-all shadow-sm">
                    <input type="checkbox" ${r.selected ? 'checked' : ''} onchange="toggleRecipient(${idx})">
                    <span class="text-xs font-mono text-slate-600 truncate">${r.email}</span>
                </label>
            `).join('');
            lucide.createIcons();
        }

        function toggleRecipient(idx) { recipients[idx].selected = !recipients[idx].selected; }
        function addRecipient() {
            const input = document.getElementById('newEmailInput');
            const email = input.value.trim();
            if (email && /^\S+@\S+\.\S+$/.test(email)) { recipients.push({ email, selected: true }); input.value = ''; renderRecipients(); }
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2; continue;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        analyzeBtn.onclick = async () => {
            const symptom = symptomInput.value.trim();
            if (!symptom) return alert("è«‹è¼¸å…¥æƒ³è¦åˆ†æçš„ç—‡ç‹€ã€‚");
            if (!config.apiKey) return toggleSettings();
            setLoading(true);
            lastSymptom = symptom;
            try {
                const result = await callGeminiWithMM(symptom);
                currentResult = result;
                renderResults(result);
                renderRecipients();
            } catch (err) { alert("åˆ†æå¤±æ•—ï¼š" + err.message); }
            finally { setLoading(false); }
        };

        // --- Core Algorithm: Detailed Expert Prompt ---
        async function callGeminiWithMM(userQuery) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå®‰æ±å°¼Â·å¨å»‰ã€Šé†«ç™‚éˆåª’ã€‹(Medical Medium) ç³»åˆ—å¢æ›¸èˆ‡ç·šä¸Šè³‡æºçš„æ¬Šå¨å°å¸«ã€‚
            
            é‡å°ç”¨æˆ¶çš„ç—‡ç‹€ï¼Œè«‹ä¾ç…§ MM çš„ç¨ç‰¹è§€é»åˆ†æç—…å› ã€æä¾›é£²é£Ÿå»ºè­°ã€‚
            
            **é—œæ–¼åƒè€ƒè³‡æ–™ (Sources) çš„åš´æ ¼è¦æ±‚ï¼š**
            1. ä½ å¿…é ˆæ˜ç¢ºæŒ‡å‡ºè«–è¿°æ˜¯å‡ºè‡ªå“ªä¸€æœ¬è‘—ä½œ (ä¾‹å¦‚ï¼šã€Šé†«ç™‚éˆåª’ã€‹ã€ã€Šæ‹¯æ•‘è‚è‡Ÿã€‹ã€ã€Šç”²ç‹€è…ºç™‚ç™’ã€‹ã€ã€Šæ·¨åŒ–ç™‚ç™’ã€‹ã€ã€Šå¤§è…¦ç™‚ç™’ã€‹)ã€‚
            2. å¦‚æœæ˜¯å‡ºè‡ªå®˜æ–¹ç¶²ç«™ã€éƒ¨è½æ ¼æˆ– Podcastï¼Œè«‹æä¾›å…·é«”çš„æ–‡ç« æ¨™é¡Œã€‚
            3. è«‹å°‡ä¾†æºåˆ†é¡ç‚º "book" (å¯¦é«”æ›¸å¼•ç”¨) æˆ– "web" (ç·šä¸Šæ–‡ç« )ã€‚
            
            å›æ‡‰æ ¼å¼è«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON çµæ§‹ï¼š
            {
              "root_cause": "æ ¸å¿ƒç—…å›  (å¦‚ EB ç—…æ¯’ç¬¬ X å‹ã€é‡é‡‘å±¬æ²‰ç©ç­‰)",
              "healing_foods": ["é£Ÿç‰©åç¨± (ç™‚ç™’åŸå› )"],
              "supplements": ["è£œå……å“åç¨± (åŠ‘é‡/å»ºè­°åŸå› )"],
              "expert_guidance": "åˆ†æ®µèªªæ˜æ”¹å–„å»ºè­°",
              "structured_sources": [
                { "type": "book", "title": "æ›¸å", "detail": "å…·é«”ç« ç¯€æˆ–è«–é»æ‘˜è¦" },
                { "type": "web", "title": "æ–‡ç« æ¨™é¡Œ", "uri": "URL é€£çµ" }
              ]
            }
            åªå›å‚³ JSONï¼Œç¦æ­¢ Markdown ä»£ç¢¼å¡Šã€‚`;

            const payload = {
                contents: [{ parts: [{ text: `ç”¨æˆ¶ç—‡ç‹€æè¿°ï¼š${userQuery}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }]
            };

            const response = await fetchWithRetry(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            const data = await response.json();
            const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const groundingMetadata = data.candidates?.[0]?.groundingMetadata;

            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error("ç„¡æ•ˆçš„å›æ‡‰æ ¼å¼ã€‚");
            const parsed = JSON.parse(jsonMatch[0]);

            // Integrate Grounding Metadata into sources
            const webSources = groundingMetadata?.groundingAttributions?.map(a => ({
                type: "web",
                title: a.web?.title || "Medical Medium Resource",
                uri: a.web?.uri || "#"
            })) || [];

            // Combine AI structured sources with Google Search grounding
            parsed.all_sources = [...(parsed.structured_sources || []), ...webSources];
            
            // Remove duplicates by title
            const uniqueSources = [];
            const seen = new Set();
            for (const s of parsed.all_sources) {
                if (s && s.title && !seen.has(s.title)) {
                    seen.add(s.title);
                    uniqueSources.push(s);
                }
            }
            parsed.sources = uniqueSources;

            return parsed;
        }

        function renderResults(data) {
            resultContent.classList.remove('hidden');
            document.getElementById('rootCause').innerText = data.root_cause || "æœªåµæ¸¬åˆ°æ˜ç¢ºç—…å› ";
            
            document.getElementById('healingFoods').innerHTML = (data.healing_foods || []).map(f => `<li class="flex items-start gap-2 mb-1"><i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500 mt-0.5"></i> <span>${f}</span></li>`).join('');
            document.getElementById('supplements').innerHTML = (data.supplements || []).map(s => `<li class="flex items-start gap-2 mb-1"><i data-lucide="plus-circle" class="w-3.5 h-3.5 text-amber-500 mt-0.5"></i> <span>${s}</span></li>`).join('');
            document.getElementById('expertGuidance').innerHTML = (data.expert_guidance || "").split('\n').filter(p => p.trim()).map(p => `<p class="mb-3">${p}</p>`).join('');
            
            document.getElementById('citations').innerHTML = (data.sources || []).map(s => `
                <div class="flex items-start gap-3 p-3 bg-slate-800/40 rounded-xl border border-slate-700/50">
                    <div class="p-2 rounded-lg bg-slate-700"><i data-lucide="${s.type === 'book' ? 'book' : 'globe'}" class="w-4 h-4 text-sky-400"></i></div>
                    <div class="flex-grow overflow-hidden text-xs text-slate-100">
                        <span class="font-bold block truncate">${s.title}</span>
                        ${s.uri ? `<a href="${s.uri}" target="_blank" class="source-link text-sky-500 truncate block mt-1">${s.uri}</a>` : (s.detail ? `<p class="text-[10px] text-slate-400 mt-1 italic">${s.detail}</p>` : '')}
                    </div>
                </div>`).join('');
            lucide.createIcons();
            window.scrollTo({ top: resultContent.offsetTop - 20, behavior: 'smooth' });
        }

        function setLoading(l) {
            loadingState.classList.toggle('hidden', !l);
            analyzeBtn.disabled = l;
            if (l) resultContent.classList.add('hidden');
            lucide.createIcons();
        }

        // --- Email Export (Table Format) ---
        document.getElementById('sendEmailBtn').onclick = async () => {
            const selectedEmails = recipients.filter(r => r.selected).map(r => r.email);
            if (!currentResult || selectedEmails.length === 0) return alert("è«‹ç¢ºèªæœ‰åˆ†æçµæœä¸”è‡³å°‘å‹¾é¸ä¸€å€‹æ”¶ä»¶äºº");
            
            const sendBtn = document.getElementById('sendEmailBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = `æ­£åœ¨ç™¼é€ä¸­...`;

            const dateStr = new Date().toISOString().split('T')[0];
            const emailHtml = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; color: #333; background-color: #f0f9ff; padding: 20px; border-radius: 12px;">
                    <h2 style="color: #0284c7; text-align: center; border-bottom: 2px solid #0284c7; padding-bottom: 10px;">MM ç—‡ç‹€ç™‚ç™’åˆ†æå ±å‘Š</h2>
                    <div style="background-color: #ffffff; padding: 15px; border-radius: 10px; border: 1px solid #e0f2fe; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong>åˆ†æç—‡ç‹€ï¼š</strong> <span style="font-size: 1.2em; color: #0369a1;">${lastSymptom}</span></p>
                        <p style="margin: 5px 0 0; font-size: 12px; color: #94a3b8;">å ±å‘Šæ—¥æœŸï¼š${dateStr}</p>
                    </div>

                    <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse; border: 1px solid #bae6fd; background-color: #ffffff;">
                        <thead>
                            <tr style="background-color: #0284c7; color: white; text-align: left;">
                                <th style="padding: 12px; border: 1px solid #0284c7;">æ ¸å¿ƒç—…å›  (Root Cause)</th>
                                <th style="padding: 12px; border: 1px solid #0284c7;">ç™‚ç™’æ–¹æ¡ˆ (Foods & Supplements)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #bae6fd; vertical-align: top; width: 35%; background-color: #fef2f2;">
                                    <strong style="color: #b91c1c;">æ ¸å¿ƒåˆ†æï¼š</strong><br/>
                                    <p style="font-size: 14px; font-weight: bold;">${currentResult.root_cause}</p>
                                </td>
                                <td style="padding: 15px; border: 1px solid #bae6fd; vertical-align: top; width: 65%;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #059669;">ğŸŒ¿ æ¨è–¦é£Ÿç‰©ï¼š</strong>
                                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                            ${currentResult.healing_foods.map(f => `<li>${f}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <strong style="color: #d97706;">ğŸ’Š å»ºè­°è£œå……å“ï¼š</strong>
                                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                            ${currentResult.supplements.map(s => `<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2" style="padding: 15px; border: 1px solid #bae6fd; background-color: #f8fafc;">
                                    <strong style="color: #0284c7;">ğŸ“š å°ˆå®¶å¼•å°å»ºè­°ï¼š</strong>
                                    <p style="font-size: 13px; line-height: 1.6; color: #334155;">${currentResult.expert_guidance.replace(/\n/g, '<br/>')}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="text-align: center; color: #94a3b8; font-size: 11px; margin-top: 25px;">
                        æ­¤å ±å‘Šç”± MM AI å°ˆå®¶ç³»çµ±ç”Ÿæˆã€‚è«‹ä»¥å®‰æ±å°¼Â·å¨å»‰ã€Šé†«ç™‚éˆåª’ã€‹åŸè‘—ç‚ºæº–ã€‚
                    </p>
                </div>
            `;

            const templateParams = {
                email: selectedEmails.join(','),
                to_email: selectedEmails.join(','),
                recipient: selectedEmails.join(','),
                subject: `MM Symptom Report: ${lastSymptom} - ${dateStr}`,
                message: emailHtml
            };

            window.emailjs.send('service_5yh7x6g', 'template_dlbyml8', templateParams)
                .then(() => {
                    emailStatus.innerText = "âœ… å ±å‘Šå·²æˆåŠŸç™¼é€è‡³æ‚¨çš„ä¿¡ç®±ï¼";
                    emailStatus.className = "text-center text-xs font-bold text-emerald-600 animate-pulse mt-2 block";
                    emailStatus.classList.remove('hidden');
                })
                .catch((err) => {
                    emailStatus.innerText = "âŒ ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèªé€£ç·šã€‚";
                    emailStatus.className = "text-center text-xs font-bold text-red-600 mt-2 block";
                    emailStatus.classList.remove('hidden');
                })
                .finally(() => {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i> ç™¼é€å®Œæ•´è¡¨æ ¼å ±å‘Š`;
                    lucide.createIcons();
                });
        };
    </script>
</body>
</html>
